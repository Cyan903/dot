#!/usr/bin/env bash

# Simple "plugin manager" for mpv

MPV_CONFIG="$HOME/.config/mpv"

err() {
    echo "$1"
    exit 1
}

add() {
    [[ -z "$1" ]] && err "No URL"

    cd "$MPV_CONFIG/ext" || err "No $MPV_CONFIG/ext"

    # Clone
    echo "-> $1 to $MPV_CONFIG/ext"
    git clone "$1" || err "Git failed"

    # Quit
    cd - || exit 1
    link
}

remove() {
    [[ ! -d "$MPV_CONFIG/ext/$1" ]] && err "$MPV_CONFIG/ext/$1 does not exist"

    unlink
    trash-put "$MPV_CONFIG/ext/$1"
    link
}

list() {
    count=0

    for plug in "$MPV_CONFIG/ext"/*; do
        if [[ ! -d "$plug" ]];
            then continue
        fi

        (( count++ ))
        echo " -> ${plug##*/}"
    done

    echo "Total: $count"
}

link() {
    for plug in "$MPV_CONFIG/ext"/*; do
        if [[ ! -d "$plug" ]];
            then continue
        fi

        name="${plug##*/}"
        ln -sf "$plug" "$MPV_CONFIG/scripts/$name"
    done
}

unlink() {
    for plug in "$MPV_CONFIG/ext"/*; do
        if [[ ! -d "$plug" ]];
            then continue
        fi

        name="${plug%/}"
        rm "$MPV_CONFIG/scripts/${name##*/}" || exit 1
    done
}

sync() {
    for plug in "$MPV_CONFIG/ext"/*; do
        if [[ ! -d "$plug" ]];
            then continue
        fi

        cd "$plug" || err "Not found"

        if [[ -d .git ]]; then
            git pull --all
        else
            echo "$PWD has no git"
        fi

        cd - > /dev/null || err "Not found"
    done

    unlink || err "Failed to unlink"
    link || err "Failed to link"
}

usage() {
    cat <<EOF
Manage mpv plugins

Usage: ./bin/plugin [options]

Options:
  add       add a plugin with git
  remove    remove a plugin with trash-put
  list      list installed plugins
  sync      sync installed plugins with git
  link      symlink installed plugins
  unlink    unlink installed plugins
  help      display help
EOF
}

# Check for config
[[ ! -d "$MPV_CONFIG" ]] && err "mpv config does not exist!"
[[ ! -d "$MPV_CONFIG/ext" ]] && err "No $MPV_CONFIG/ext"

# Parse CLI
case "$1" in
    add) add "$2" ;;
    remove) remove "$2" ;;
    list) list ;;
    sync) sync ;;
    link) link ;;
    unlink) unlink ;;

    *)
        usage
        exit 1
    ;;
esac

